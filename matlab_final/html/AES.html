
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>AES</title><meta name="generator" content="MATLAB 8.6"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-07-24"><meta name="DC.source" content="AES.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">AES</a></li><li><a href="#3">AES_RSM_Test</a></li><li><a href="#4">AES_RSM</a></li><li><a href="#5">AES_256_Test</a></li><li><a href="#6">AES_256</a></li><li><a href="#7">TextToMatrix</a></li><li><a href="#8">MatrixToText</a></li><li><a href="#9">ByteXor</a></li><li><a href="#10">MatrixXor</a></li><li><a href="#11">AddRoundKey</a></li><li><a href="#12">SubBytes</a></li><li><a href="#13">ShiftRows</a></li><li><a href="#14">GFMul</a></li><li><a href="#15">MixColumns</a></li><li><a href="#16">KeySchedule</a></li><li><a href="#17">Mask</a></li><li><a href="#18">MaskedSubBytes</a></li><li><a href="#19">MaskCompensation</a></li><li><a href="#20">MaskCompensationLastRound</a></li></ul></div><pre class="codeinput"><span class="comment">% 256-bit Key:        6cecc67f287d083deb8766f0738b36cf164ed9b246951090869d08285d2e193b</span>
<span class="comment">% 128-bit Plaintext:  448ff4f8eae2cea393553e15fd00eca1</span>
<span class="comment">% 128-bit Ciphertext: f71e9995e754e9f711b4027106a72788</span>
<span class="comment">% Offset:             8</span>
<span class="comment">% Directory Name:     00000</span>
<span class="comment">% Trace Name:         Z1Trace00000.trc.bz2</span>
</pre><h2>AES<a name="2"></a></h2><pre class="codeinput"><span class="keyword">function</span> AES()
<span class="comment">% AES_256_Test()</span>
tic
AES_RSM_Test()
toc
<span class="keyword">end</span>
</pre><h2>AES_RSM_Test<a name="3"></a></h2><pre class="codeinput"><span class="keyword">function</span> AES_RSM_Test()
cipher_key = <span class="string">'6cecc67f287d083deb8766f0738b36cf164ed9b246951090869d08285d2e193b'</span>
plain_text = <span class="string">'448ff4f8eae2cea393553e15fd00eca1'</span>
<span class="comment">% cipher_text = 'f71e9995e754e9f711b4027106a72788'</span>
<span class="comment">% plain_text  = 'd0edb7612c4dc8aa42358571649af40c'</span>
<span class="comment">% cipher_text = 'f0fbbbb6e7d2befb7b947e9250fcd754'</span>
offset = 8

cipher_text = AES_RSM(cipher_key,plain_text,offset)
<span class="comment">% cipher_text = AES_256(cipher_key,plain_text)</span>


<span class="keyword">end</span>
</pre><pre class="codeoutput">
cipher_key =

6cecc67f287d083deb8766f0738b36cf164ed9b246951090869d08285d2e193b


plain_text =

448ff4f8eae2cea393553e15fd00eca1


offset =

     8

</pre><h2>AES_RSM<a name="4"></a></h2><pre class="codeinput"><span class="keyword">function</span> cipher_text = AES_RSM(cipher_key,plain_text,offset)
<span class="comment">% Refer to these:</span>
<span class="comment">%   "Description of the masked AES of the DPA contest v4": Algorithm 1</span>
<span class="comment">%      http://www.dpacontest.org/v4/data/rsm/aes-rsm.pdf</span>

<span class="comment">% ---------- AES-256 ---------- %</span>
Nb = 4;                  <span class="comment">% Nb: Block Number</span>
Nr = 14;                 <span class="comment">% Nr: Round Number</span>
Nk = 8;                  <span class="comment">% Nk: Cipher Key Size</span>

cipher_key   = TextToMatrix(cipher_key);
plain_text   = TextToMatrix(plain_text);
expanded_key = KeySchedule(cipher_key);

state = plain_text;

state = MatrixXor(state,Mask(offset));

state = AddRoundKey(state,expanded_key(:,1:Nb));

<span class="keyword">for</span> round = 1:Nr-1
    state = MaskedSubBytes(state,offset+round-1);
    state = ShiftRows(state);
    state = MixColumns(state);
    state = MatrixXor(state,MaskCompensation(offset+round));
    state = AddRoundKey(state,expanded_key(:,Nb*round+1:Nb*(round+1)));
<span class="keyword">end</span>

state = MaskedSubBytes(state,offset+Nr-1);
state = ShiftRows(state);
state = AddRoundKey(state,expanded_key(:,Nb*Nr+1:Nb*(Nr+1)));
state = MatrixXor(state,MaskCompensationLastRound(offset+Nr));

cipher_text = state;
cipher_text = MatrixToText(cipher_text);

<span class="keyword">end</span>
</pre><h2>AES_256_Test<a name="5"></a></h2><pre class="codeinput"><span class="keyword">function</span> AES_256_Test()
plain_text = <span class="string">'00112233445566778899aabbccddeeff'</span>
cipher_key = <span class="string">'000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f'</span>

cipher_text = AES_256(cipher_key,plain_text);
<span class="comment">% cipher_text = '8ea2b7ca516745bfeafc49904b496089'</span>
<span class="keyword">end</span>
</pre><h2>AES_256<a name="6"></a></h2><pre class="codeinput"><span class="keyword">function</span> cipher_text = AES_256(cipher_key,plain_text)
<span class="comment">% Refer to these:</span>
<span class="comment">%   "Announcing the ADVANCED ENCRYPTION STANDARD (AES)": Section 5.1 --- Cipher</span>
<span class="comment">%      http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf</span>

<span class="comment">% ---------- AES-256 ---------- %</span>
Nb = 4;                  <span class="comment">% Nb: Block Number</span>
Nr = 14;                 <span class="comment">% Nr: Round Number</span>
Nk = 8;                  <span class="comment">% Nk: Cipher Key Size</span>

cipher_key   = TextToMatrix(cipher_key);
plain_text   = TextToMatrix(plain_text);
expanded_key = KeySchedule(cipher_key);

state = plain_text;

state = AddRoundKey(state,expanded_key(:,1:Nb));

<span class="keyword">for</span> round = 1:Nr-1
    state = SubBytes(state);
    state = ShiftRows(state);
    state = MixColumns(state);
    state = AddRoundKey(state,expanded_key(:,Nb*round+1:Nb*(round+1)));
<span class="keyword">end</span>

state = SubBytes(state);
state = ShiftRows(state);
state = AddRoundKey(state,expanded_key(:,Nb*Nr+1:Nb*(Nr+1)));

cipher_text = state;
cipher_text = MatrixToText(cipher_text);
<span class="keyword">end</span>
</pre><h2>TextToMatrix<a name="7"></a></h2><pre class="codeinput"><span class="keyword">function</span> matrix = TextToMatrix(text)
<span class="comment">% Size of matrix: 4 by N</span>
row = 4;
col = numel(text)/8;
matrix = cell(row,col);
<span class="keyword">for</span> i = 1:row*col
    matrix{i} = [text(2*i-1),text(2*i)];
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>MatrixToText<a name="8"></a></h2><pre class="codeinput"><span class="keyword">function</span> text = MatrixToText(matrix)
<span class="comment">% Size of matrix: 4 by N</span>
text = blanks(2*numel(matrix));
<span class="keyword">for</span> i = 1:numel(matrix)
    text(2*i-1) = matrix{i}(1);
    text(2*i)   = matrix{i}(2);
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><pre class="codeoutput">
cipher_text =

F71E9995E754E9F711B4027106A72788

Elapsed time is 19.056341 seconds.
</pre><h2>ByteXor<a name="9"></a></h2><pre class="codeinput"><span class="keyword">function</span> byte_out = ByteXor(byte1,byte2)
binvec1     = hexToBinaryVector(byte1,8);
binvec2     = hexToBinaryVector(byte2,8);
binvec_xor  = bitxor(binvec1,binvec2);
byte_out    = binaryVectorToHex(binvec_xor);
<span class="keyword">end</span>
</pre><h2>MatrixXor<a name="10"></a></h2><pre class="codeinput"><span class="keyword">function</span> matrix_out = MatrixXor(matrix1,matrix2)
<span class="comment">% Type of matrix 1 &amp; 2 :    Cell</span>
<span class="comment">% Element of matrix 1 &amp; 2 : Byte</span>
matrix_out = cell(size(matrix1));
<span class="keyword">for</span> i = 1:numel(matrix1)
    matrix_out{i} = ByteXor(matrix1{i},matrix2{i});
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>AddRoundKey<a name="11"></a></h2><pre class="codeinput"><span class="keyword">function</span> state_out = AddRoundKey(state_in,key_in)
state_out = MatrixXor(state_in,key_in);
<span class="keyword">end</span>
</pre><h2>SubBytes<a name="12"></a></h2><pre class="codeinput"><span class="keyword">function</span> state_out = SubBytes(state_in)
sbox = {
    <span class="string">'63'</span>,<span class="string">'7C'</span>,<span class="string">'77'</span>,<span class="string">'7B'</span>,<span class="string">'F2'</span>,<span class="string">'6B'</span>,<span class="string">'6F'</span>,<span class="string">'C5'</span>,<span class="string">'30'</span>,<span class="string">'01'</span>,<span class="string">'67'</span>,<span class="string">'2B'</span>,<span class="string">'FE'</span>,<span class="string">'D7'</span>,<span class="string">'AB'</span>,<span class="string">'76'</span>;
    <span class="string">'CA'</span>,<span class="string">'82'</span>,<span class="string">'C9'</span>,<span class="string">'7D'</span>,<span class="string">'FA'</span>,<span class="string">'59'</span>,<span class="string">'47'</span>,<span class="string">'F0'</span>,<span class="string">'AD'</span>,<span class="string">'D4'</span>,<span class="string">'A2'</span>,<span class="string">'AF'</span>,<span class="string">'9C'</span>,<span class="string">'A4'</span>,<span class="string">'72'</span>,<span class="string">'C0'</span>;
    <span class="string">'B7'</span>,<span class="string">'FD'</span>,<span class="string">'93'</span>,<span class="string">'26'</span>,<span class="string">'36'</span>,<span class="string">'3F'</span>,<span class="string">'F7'</span>,<span class="string">'CC'</span>,<span class="string">'34'</span>,<span class="string">'A5'</span>,<span class="string">'E5'</span>,<span class="string">'F1'</span>,<span class="string">'71'</span>,<span class="string">'D8'</span>,<span class="string">'31'</span>,<span class="string">'15'</span>;
    <span class="string">'04'</span>,<span class="string">'C7'</span>,<span class="string">'23'</span>,<span class="string">'C3'</span>,<span class="string">'18'</span>,<span class="string">'96'</span>,<span class="string">'05'</span>,<span class="string">'9A'</span>,<span class="string">'07'</span>,<span class="string">'12'</span>,<span class="string">'80'</span>,<span class="string">'E2'</span>,<span class="string">'EB'</span>,<span class="string">'27'</span>,<span class="string">'B2'</span>,<span class="string">'75'</span>;
    <span class="string">'09'</span>,<span class="string">'83'</span>,<span class="string">'2C'</span>,<span class="string">'1A'</span>,<span class="string">'1B'</span>,<span class="string">'6E'</span>,<span class="string">'5A'</span>,<span class="string">'A0'</span>,<span class="string">'52'</span>,<span class="string">'3B'</span>,<span class="string">'D6'</span>,<span class="string">'B3'</span>,<span class="string">'29'</span>,<span class="string">'E3'</span>,<span class="string">'2F'</span>,<span class="string">'84'</span>;
    <span class="string">'53'</span>,<span class="string">'D1'</span>,<span class="string">'00'</span>,<span class="string">'ED'</span>,<span class="string">'20'</span>,<span class="string">'FC'</span>,<span class="string">'B1'</span>,<span class="string">'5B'</span>,<span class="string">'6A'</span>,<span class="string">'CB'</span>,<span class="string">'BE'</span>,<span class="string">'39'</span>,<span class="string">'4A'</span>,<span class="string">'4C'</span>,<span class="string">'58'</span>,<span class="string">'CF'</span>;
    <span class="string">'D0'</span>,<span class="string">'EF'</span>,<span class="string">'AA'</span>,<span class="string">'FB'</span>,<span class="string">'43'</span>,<span class="string">'4D'</span>,<span class="string">'33'</span>,<span class="string">'85'</span>,<span class="string">'45'</span>,<span class="string">'F9'</span>,<span class="string">'02'</span>,<span class="string">'7F'</span>,<span class="string">'50'</span>,<span class="string">'3C'</span>,<span class="string">'9F'</span>,<span class="string">'A8'</span>;
    <span class="string">'51'</span>,<span class="string">'A3'</span>,<span class="string">'40'</span>,<span class="string">'8F'</span>,<span class="string">'92'</span>,<span class="string">'9D'</span>,<span class="string">'38'</span>,<span class="string">'F5'</span>,<span class="string">'BC'</span>,<span class="string">'B6'</span>,<span class="string">'DA'</span>,<span class="string">'21'</span>,<span class="string">'10'</span>,<span class="string">'FF'</span>,<span class="string">'F3'</span>,<span class="string">'D2'</span>;
    <span class="string">'CD'</span>,<span class="string">'0C'</span>,<span class="string">'13'</span>,<span class="string">'EC'</span>,<span class="string">'5F'</span>,<span class="string">'97'</span>,<span class="string">'44'</span>,<span class="string">'17'</span>,<span class="string">'C4'</span>,<span class="string">'A7'</span>,<span class="string">'7E'</span>,<span class="string">'3D'</span>,<span class="string">'64'</span>,<span class="string">'5D'</span>,<span class="string">'19'</span>,<span class="string">'73'</span>;
    <span class="string">'60'</span>,<span class="string">'81'</span>,<span class="string">'4F'</span>,<span class="string">'DC'</span>,<span class="string">'22'</span>,<span class="string">'2A'</span>,<span class="string">'90'</span>,<span class="string">'88'</span>,<span class="string">'46'</span>,<span class="string">'EE'</span>,<span class="string">'B8'</span>,<span class="string">'14'</span>,<span class="string">'DE'</span>,<span class="string">'5E'</span>,<span class="string">'0B'</span>,<span class="string">'DB'</span>;
    <span class="string">'E0'</span>,<span class="string">'32'</span>,<span class="string">'3A'</span>,<span class="string">'0A'</span>,<span class="string">'49'</span>,<span class="string">'06'</span>,<span class="string">'24'</span>,<span class="string">'5C'</span>,<span class="string">'C2'</span>,<span class="string">'D3'</span>,<span class="string">'AC'</span>,<span class="string">'62'</span>,<span class="string">'91'</span>,<span class="string">'95'</span>,<span class="string">'E4'</span>,<span class="string">'79'</span>;
    <span class="string">'E7'</span>,<span class="string">'C8'</span>,<span class="string">'37'</span>,<span class="string">'6D'</span>,<span class="string">'8D'</span>,<span class="string">'D5'</span>,<span class="string">'4E'</span>,<span class="string">'A9'</span>,<span class="string">'6C'</span>,<span class="string">'56'</span>,<span class="string">'F4'</span>,<span class="string">'EA'</span>,<span class="string">'65'</span>,<span class="string">'7A'</span>,<span class="string">'AE'</span>,<span class="string">'08'</span>;
    <span class="string">'BA'</span>,<span class="string">'78'</span>,<span class="string">'25'</span>,<span class="string">'2E'</span>,<span class="string">'1C'</span>,<span class="string">'A6'</span>,<span class="string">'B4'</span>,<span class="string">'C6'</span>,<span class="string">'E8'</span>,<span class="string">'DD'</span>,<span class="string">'74'</span>,<span class="string">'1F'</span>,<span class="string">'4B'</span>,<span class="string">'BD'</span>,<span class="string">'8B'</span>,<span class="string">'8A'</span>;
    <span class="string">'70'</span>,<span class="string">'3E'</span>,<span class="string">'B5'</span>,<span class="string">'66'</span>,<span class="string">'48'</span>,<span class="string">'03'</span>,<span class="string">'F6'</span>,<span class="string">'0E'</span>,<span class="string">'61'</span>,<span class="string">'35'</span>,<span class="string">'57'</span>,<span class="string">'B9'</span>,<span class="string">'86'</span>,<span class="string">'C1'</span>,<span class="string">'1D'</span>,<span class="string">'9E'</span>;
    <span class="string">'E1'</span>,<span class="string">'F8'</span>,<span class="string">'98'</span>,<span class="string">'11'</span>,<span class="string">'69'</span>,<span class="string">'D9'</span>,<span class="string">'8E'</span>,<span class="string">'94'</span>,<span class="string">'9B'</span>,<span class="string">'1E'</span>,<span class="string">'87'</span>,<span class="string">'E9'</span>,<span class="string">'CE'</span>,<span class="string">'55'</span>,<span class="string">'28'</span>,<span class="string">'DF'</span>;
    <span class="string">'8C'</span>,<span class="string">'A1'</span>,<span class="string">'89'</span>,<span class="string">'0D'</span>,<span class="string">'BF'</span>,<span class="string">'E6'</span>,<span class="string">'42'</span>,<span class="string">'68'</span>,<span class="string">'41'</span>,<span class="string">'99'</span>,<span class="string">'2D'</span>,<span class="string">'0F'</span>,<span class="string">'B0'</span>,<span class="string">'54'</span>,<span class="string">'BB'</span>,<span class="string">'16'</span>
    };

<span class="comment">% sbox_dec = reshape(hex2dec(sbox),16,16);</span>
state_out = cell(size(state_in));
<span class="keyword">for</span> i = 1:numel(state_in)
    row = hex2dec(state_in{i}(1))+1;
    col = hex2dec(state_in{i}(2))+1;
    state_out(i) = sbox(row,col);
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>ShiftRows<a name="13"></a></h2><pre class="codeinput"><span class="keyword">function</span> state_out = ShiftRows(state_in)
<span class="comment">% Size of state_in : 4 x 4</span>
state_out = cell(size(state_in));
<span class="comment">% circshift(V,K,D):</span>
<span class="comment">%     V: Vector</span>
<span class="comment">%     K: Right shift K positions. We need Left shift -K in AES.</span>
<span class="comment">%     D: Dimension shifted. D=2 here.</span>
state_out(1,:) = circshift(state_in(1,:), 0,2);
state_out(2,:) = circshift(state_in(2,:),-1,2);
state_out(3,:) = circshift(state_in(3,:),-2,2);
state_out(4,:) = circshift(state_in(4,:),-3,2);
<span class="keyword">end</span>
</pre><h2>GFMul<a name="14"></a></h2><pre class="codeinput"><span class="keyword">function</span> byte_out = GFMul(num,byte_in)
<span class="comment">% C = bitsll(B, N); ---- Bit Shift Left Logical</span>
<span class="comment">% Left shift B by N bits. B must be numeric types.</span>
<span class="keyword">if</span> num == 1
    byte_out = byte_in;
<span class="keyword">else</span>
    byte_shifted = dec2hex(bitsll(uint8(hex2dec(byte_in)),1));
    <span class="keyword">if</span> hex2dec(byte_in(1)) &gt;= 8     <span class="comment">% MSB == 1</span>
        byte_xor = ByteXor(byte_shifted,<span class="string">'1B'</span>);
    <span class="keyword">else</span>                            <span class="comment">% MSB == 0</span>
        byte_xor = ByteXor(byte_shifted,<span class="string">'00'</span>);
    <span class="keyword">end</span>

    <span class="keyword">if</span> num == 2
        byte_out = byte_xor;
    <span class="keyword">else</span>    <span class="comment">% num ==3</span>
        byte_out = ByteXor(byte_xor,byte_in);
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>MixColumns<a name="15"></a></h2><pre class="codeinput"><span class="keyword">function</span> state_out = MixColumns(state_in)
<span class="comment">% Refer to this :</span>
<span class="comment">%   "How to solve MixColumns":</span>
<span class="comment">%      https://crypto.stackexchange.com/questions/2402/how-to-solve-mixcolumns</span>
mixbox = {
    2,3,1,1;
    1,2,3,1;
    1,1,2,3;
    3,1,1,2
    };
state_out = cell(size(state_in));

<span class="keyword">for</span> row = 1:size(state_in,1)
    <span class="keyword">for</span> col = 1:size(state_in,2)
        mul_tmp = <span class="string">'00'</span>;
        xor_tmp = <span class="string">'00'</span>;
        <span class="keyword">for</span> k = 1:4
            mul_tmp = GFMul(mixbox{row,k},state_in{k,col});
            xor_tmp = ByteXor(xor_tmp,mul_tmp);
        <span class="keyword">end</span>
        state_out{row,col} = xor_tmp;
    <span class="keyword">end</span>
<span class="keyword">end</span>
<span class="keyword">end</span>
</pre><h2>KeySchedule<a name="16"></a></h2><pre class="codeinput"><span class="keyword">function</span> expanded_key = KeySchedule(cipher_key)
<span class="comment">% Refer to these:</span>
<span class="comment">%   "How to use RCON In Key Expansion of 128 Bit Advanced Encryption Standard"</span>
<span class="comment">%      https://crypto.stackexchange.com/questions/2418/how-to-use-rcon-in-key-expansion-of-128-bit-advanced-encryption-standard</span>
<span class="comment">%   "Announcing the ADVANCED ENCRYPTION STANDARD (AES)": Appendix A -- Key Expansion Examples</span>
<span class="comment">%      http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf</span>
<span class="comment">%   "The Design of Rijndael": Section 3.6 -- Key Schedule</span>
<span class="comment">%      https://link.springer.com/content/pdf/10.1007%2F978-3-662-04722-4.pdf</span>

<span class="comment">% ---------- AES-256 ---------- %</span>
Nb = 4;                  <span class="comment">% Nb: Block Number</span>
Nr = 14;                 <span class="comment">% Nr: Round Number</span>
Nk = 8;                  <span class="comment">% Nk: Cipher Key Size</span>
K = cipher_key;          <span class="comment">% K : Cipher Key     Nb x Nk     = 4 x 8</span>
W = cell(Nb,Nb*(Nr+1));  <span class="comment">% W : Expanded Key   Nb x (Nr+1) = 4 x 15</span>

RC = { <span class="comment">% Round Constants</span>
    <span class="string">'01'</span>,<span class="string">'02'</span>,<span class="string">'04'</span>,<span class="string">'08'</span>,<span class="string">'10'</span>,<span class="string">'20'</span>,<span class="string">'40'</span>;
    <span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>;
    <span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>;
    <span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>,<span class="string">'00'</span>
    };

W(1:4,1:8) = K(1:4,1:8);
<span class="keyword">for</span> col = 9:Nb*(Nr+1)
    <span class="keyword">if</span> mod(col-1,Nk) == 0
        vec_tmp = circshift(W(:,col-1),-1,1);
        vec_tmp = SubBytes(vec_tmp);
        xor_tmp  = MatrixXor( vec_tmp, W(:,col-Nk) );
        W(:,col) = MatrixXor( xor_tmp, RC(:,(col-1)/Nk) );
    <span class="keyword">elseif</span> mod(col-1,Nk) == 4
        vec_tmp = W(:,col-1);
        vec_tmp = SubBytes(vec_tmp);
        W(:,col) = MatrixXor( vec_tmp, W(:,col-Nk) );
    <span class="keyword">else</span>
        vec_tmp = W(:,col-1);
        W(:,col) = MatrixXor( vec_tmp, W(:,col-Nk) );
    <span class="keyword">end</span>
<span class="keyword">end</span>
expanded_key = W;
<span class="keyword">end</span>
</pre><h2>Mask<a name="17"></a></h2><pre class="codeinput"><span class="keyword">function</span> mask = Mask(offset)
maskbox = {
    <span class="string">'00'</span>,<span class="string">'0F'</span>,<span class="string">'36'</span>,<span class="string">'39'</span>,<span class="string">'53'</span>,<span class="string">'5C'</span>,<span class="string">'65'</span>,<span class="string">'6A'</span>, <span class="keyword">...</span>
    <span class="string">'95'</span>,<span class="string">'9A'</span>,<span class="string">'A3'</span>,<span class="string">'AC'</span>,<span class="string">'C6'</span>,<span class="string">'C9'</span>,<span class="string">'F0'</span>,<span class="string">'FF'</span>
    };
mask = circshift(maskbox,-offset,2);
mask = reshape(mask,4,4);
<span class="keyword">end</span>
</pre><h2>MaskedSubBytes<a name="18"></a></h2><pre class="codeinput"><span class="keyword">function</span> state_out = MaskedSubBytes(state_in,offset)
state_tmp = MatrixXor(state_in,Mask(offset));
state_tmp = SubBytes(state_tmp);
state_out = MatrixXor(state_tmp,Mask(offset+1));
<span class="keyword">end</span>
</pre><h2>MaskCompensation<a name="19"></a></h2><pre class="codeinput"><span class="keyword">function</span> mask = MaskCompensation(offset)
mask_tmp = Mask(offset);
mask_tmp = ShiftRows(mask_tmp);
mask_tmp = MixColumns(mask_tmp);
mask = MatrixXor(mask_tmp,Mask(offset));
<span class="keyword">end</span>
</pre><h2>MaskCompensationLastRound<a name="20"></a></h2><pre class="codeinput"><span class="keyword">function</span> mask = MaskCompensationLastRound(offset)
mask_tmp = Mask(offset);
mask_tmp = ShiftRows(mask_tmp);
mask = mask_tmp;
<span class="keyword">end</span>
</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2015b</a><br></p></div><!--
##### SOURCE BEGIN #####
% 256-bit Key:        6cecc67f287d083deb8766f0738b36cf164ed9b246951090869d08285d2e193b 
% 128-bit Plaintext:  448ff4f8eae2cea393553e15fd00eca1
% 128-bit Ciphertext: f71e9995e754e9f711b4027106a72788
% Offset:             8 
% Directory Name:     00000 
% Trace Name:         Z1Trace00000.trc.bz2

%% AES
function AES()
% AES_256_Test()
tic
AES_RSM_Test()
toc
end

%% AES_RSM_Test
function AES_RSM_Test()
cipher_key = '6cecc67f287d083deb8766f0738b36cf164ed9b246951090869d08285d2e193b'
plain_text = '448ff4f8eae2cea393553e15fd00eca1'
% cipher_text = 'f71e9995e754e9f711b4027106a72788'
% plain_text  = 'd0edb7612c4dc8aa42358571649af40c'
% cipher_text = 'f0fbbbb6e7d2befb7b947e9250fcd754'
offset = 8

cipher_text = AES_RSM(cipher_key,plain_text,offset)
% cipher_text = AES_256(cipher_key,plain_text)


end

%% AES_RSM
function cipher_text = AES_RSM(cipher_key,plain_text,offset)
% Refer to these: 
%   "Description of the masked AES of the DPA contest v4": Algorithm 1
%      http://www.dpacontest.org/v4/data/rsm/aes-rsm.pdf

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH AES-256 REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH %
Nb = 4;                  % Nb: Block Number
Nr = 14;                 % Nr: Round Number
Nk = 8;                  % Nk: Cipher Key Size

cipher_key   = TextToMatrix(cipher_key);
plain_text   = TextToMatrix(plain_text);
expanded_key = KeySchedule(cipher_key);

state = plain_text;

state = MatrixXor(state,Mask(offset));

state = AddRoundKey(state,expanded_key(:,1:Nb));

for round = 1:Nr-1
    state = MaskedSubBytes(state,offset+round-1);
    state = ShiftRows(state);
    state = MixColumns(state);
    state = MatrixXor(state,MaskCompensation(offset+round));
    state = AddRoundKey(state,expanded_key(:,Nb*round+1:Nb*(round+1)));
end

state = MaskedSubBytes(state,offset+Nr-1);
state = ShiftRows(state);
state = AddRoundKey(state,expanded_key(:,Nb*Nr+1:Nb*(Nr+1)));
state = MatrixXor(state,MaskCompensationLastRound(offset+Nr));

cipher_text = state;
cipher_text = MatrixToText(cipher_text);

end

%% AES_256_Test
function AES_256_Test()
plain_text = '00112233445566778899aabbccddeeff'
cipher_key = '000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f'

cipher_text = AES_256(cipher_key,plain_text);
% cipher_text = '8ea2b7ca516745bfeafc49904b496089'
end

%% AES_256
function cipher_text = AES_256(cipher_key,plain_text)
% Refer to these: 
%   "Announcing the ADVANCED ENCRYPTION STANDARD (AES)": Section 5.1 REPLACE_WITH_DASH_DASH- Cipher
%      http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH AES-256 REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH %
Nb = 4;                  % Nb: Block Number
Nr = 14;                 % Nr: Round Number
Nk = 8;                  % Nk: Cipher Key Size

cipher_key   = TextToMatrix(cipher_key);
plain_text   = TextToMatrix(plain_text);
expanded_key = KeySchedule(cipher_key);

state = plain_text;

state = AddRoundKey(state,expanded_key(:,1:Nb));

for round = 1:Nr-1
    state = SubBytes(state);
    state = ShiftRows(state);
    state = MixColumns(state);
    state = AddRoundKey(state,expanded_key(:,Nb*round+1:Nb*(round+1)));
end

state = SubBytes(state);
state = ShiftRows(state);
state = AddRoundKey(state,expanded_key(:,Nb*Nr+1:Nb*(Nr+1)));

cipher_text = state;
cipher_text = MatrixToText(cipher_text);
end

%% TextToMatrix
function matrix = TextToMatrix(text)
% Size of matrix: 4 by N
row = 4;
col = numel(text)/8;
matrix = cell(row,col);
for i = 1:row*col
    matrix{i} = [text(2*i-1),text(2*i)];
end
end

%% MatrixToText
function text = MatrixToText(matrix)
% Size of matrix: 4 by N
text = blanks(2*numel(matrix));
for i = 1:numel(matrix)
    text(2*i-1) = matrix{i}(1);
    text(2*i)   = matrix{i}(2);
end
end
%% ByteXor
function byte_out = ByteXor(byte1,byte2)
binvec1     = hexToBinaryVector(byte1,8);
binvec2     = hexToBinaryVector(byte2,8);
binvec_xor  = bitxor(binvec1,binvec2);
byte_out    = binaryVectorToHex(binvec_xor);
end

%% MatrixXor
function matrix_out = MatrixXor(matrix1,matrix2)
% Type of matrix 1 & 2 :    Cell
% Element of matrix 1 & 2 : Byte
matrix_out = cell(size(matrix1));
for i = 1:numel(matrix1)
    matrix_out{i} = ByteXor(matrix1{i},matrix2{i});
end
end

%% AddRoundKey
function state_out = AddRoundKey(state_in,key_in)
state_out = MatrixXor(state_in,key_in);
end

%% SubBytes
function state_out = SubBytes(state_in)
sbox = { 
    '63','7C','77','7B','F2','6B','6F','C5','30','01','67','2B','FE','D7','AB','76';
    'CA','82','C9','7D','FA','59','47','F0','AD','D4','A2','AF','9C','A4','72','C0';
    'B7','FD','93','26','36','3F','F7','CC','34','A5','E5','F1','71','D8','31','15';
    '04','C7','23','C3','18','96','05','9A','07','12','80','E2','EB','27','B2','75';
    '09','83','2C','1A','1B','6E','5A','A0','52','3B','D6','B3','29','E3','2F','84';
    '53','D1','00','ED','20','FC','B1','5B','6A','CB','BE','39','4A','4C','58','CF';
    'D0','EF','AA','FB','43','4D','33','85','45','F9','02','7F','50','3C','9F','A8';
    '51','A3','40','8F','92','9D','38','F5','BC','B6','DA','21','10','FF','F3','D2';
    'CD','0C','13','EC','5F','97','44','17','C4','A7','7E','3D','64','5D','19','73';
    '60','81','4F','DC','22','2A','90','88','46','EE','B8','14','DE','5E','0B','DB';
    'E0','32','3A','0A','49','06','24','5C','C2','D3','AC','62','91','95','E4','79';
    'E7','C8','37','6D','8D','D5','4E','A9','6C','56','F4','EA','65','7A','AE','08';
    'BA','78','25','2E','1C','A6','B4','C6','E8','DD','74','1F','4B','BD','8B','8A';
    '70','3E','B5','66','48','03','F6','0E','61','35','57','B9','86','C1','1D','9E';
    'E1','F8','98','11','69','D9','8E','94','9B','1E','87','E9','CE','55','28','DF';
    '8C','A1','89','0D','BF','E6','42','68','41','99','2D','0F','B0','54','BB','16'
    };

% sbox_dec = reshape(hex2dec(sbox),16,16);
state_out = cell(size(state_in));
for i = 1:numel(state_in)
    row = hex2dec(state_in{i}(1))+1;
    col = hex2dec(state_in{i}(2))+1;
    state_out(i) = sbox(row,col);
end
end

%% ShiftRows
function state_out = ShiftRows(state_in)
% Size of state_in : 4 x 4
state_out = cell(size(state_in));
% circshift(V,K,D):
%     V: Vector
%     K: Right shift K positions. We need Left shift -K in AES.
%     D: Dimension shifted. D=2 here.
state_out(1,:) = circshift(state_in(1,:), 0,2);
state_out(2,:) = circshift(state_in(2,:),-1,2);
state_out(3,:) = circshift(state_in(3,:),-2,2);
state_out(4,:) = circshift(state_in(4,:),-3,2);
end

%% GFMul
function byte_out = GFMul(num,byte_in)
% C = bitsll(B, N); REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH Bit Shift Left Logical
% Left shift B by N bits. B must be numeric types.
if num == 1
    byte_out = byte_in;
else
    byte_shifted = dec2hex(bitsll(uint8(hex2dec(byte_in)),1));    
    if hex2dec(byte_in(1)) >= 8     % MSB == 1
        byte_xor = ByteXor(byte_shifted,'1B');
    else                            % MSB == 0
        byte_xor = ByteXor(byte_shifted,'00');
    end
    
    if num == 2
        byte_out = byte_xor;
    else    % num ==3
        byte_out = ByteXor(byte_xor,byte_in);
    end
end
end

%% MixColumns
function state_out = MixColumns(state_in)
% Refer to this : 
%   "How to solve MixColumns":
%      https://crypto.stackexchange.com/questions/2402/how-to-solve-mixcolumns
mixbox = {
    2,3,1,1;
    1,2,3,1;
    1,1,2,3;
    3,1,1,2
    };
state_out = cell(size(state_in));

for row = 1:size(state_in,1)
    for col = 1:size(state_in,2)
        mul_tmp = '00';
        xor_tmp = '00';
        for k = 1:4
            mul_tmp = GFMul(mixbox{row,k},state_in{k,col});
            xor_tmp = ByteXor(xor_tmp,mul_tmp);
        end
        state_out{row,col} = xor_tmp;
    end
end
end

%% KeySchedule
function expanded_key = KeySchedule(cipher_key)
% Refer to these: 
%   "How to use RCON In Key Expansion of 128 Bit Advanced Encryption Standard"
%      https://crypto.stackexchange.com/questions/2418/how-to-use-rcon-in-key-expansion-of-128-bit-advanced-encryption-standard
%   "Announcing the ADVANCED ENCRYPTION STANDARD (AES)": Appendix A REPLACE_WITH_DASH_DASH Key Expansion Examples
%      http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.197.pdf
%   "The Design of Rijndael": Section 3.6 REPLACE_WITH_DASH_DASH Key Schedule
%      https://link.springer.com/content/pdf/10.1007%2F978-3-662-04722-4.pdf

% REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH AES-256 REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH %
Nb = 4;                  % Nb: Block Number
Nr = 14;                 % Nr: Round Number
Nk = 8;                  % Nk: Cipher Key Size
K = cipher_key;          % K : Cipher Key     Nb x Nk     = 4 x 8
W = cell(Nb,Nb*(Nr+1));  % W : Expanded Key   Nb x (Nr+1) = 4 x 15

RC = { % Round Constants
    '01','02','04','08','10','20','40';
    '00','00','00','00','00','00','00';
    '00','00','00','00','00','00','00';
    '00','00','00','00','00','00','00'
    };

W(1:4,1:8) = K(1:4,1:8);
for col = 9:Nb*(Nr+1)
    if mod(col-1,Nk) == 0
        vec_tmp = circshift(W(:,col-1),-1,1);
        vec_tmp = SubBytes(vec_tmp);
        xor_tmp  = MatrixXor( vec_tmp, W(:,col-Nk) );
        W(:,col) = MatrixXor( xor_tmp, RC(:,(col-1)/Nk) );
    elseif mod(col-1,Nk) == 4
        vec_tmp = W(:,col-1);
        vec_tmp = SubBytes(vec_tmp);
        W(:,col) = MatrixXor( vec_tmp, W(:,col-Nk) );
    else
        vec_tmp = W(:,col-1);
        W(:,col) = MatrixXor( vec_tmp, W(:,col-Nk) );
    end
end
expanded_key = W;
end

%% Mask
function mask = Mask(offset)
maskbox = {
    '00','0F','36','39','53','5C','65','6A', ...
    '95','9A','A3','AC','C6','C9','F0','FF'
    };
mask = circshift(maskbox,-offset,2);
mask = reshape(mask,4,4);
end

%% MaskedSubBytes
function state_out = MaskedSubBytes(state_in,offset)
state_tmp = MatrixXor(state_in,Mask(offset));
state_tmp = SubBytes(state_tmp);
state_out = MatrixXor(state_tmp,Mask(offset+1)); 
end

%% MaskCompensation
function mask = MaskCompensation(offset)
mask_tmp = Mask(offset);
mask_tmp = ShiftRows(mask_tmp);
mask_tmp = MixColumns(mask_tmp);
mask = MatrixXor(mask_tmp,Mask(offset));
end

%% MaskCompensationLastRound
function mask = MaskCompensationLastRound(offset)
mask_tmp = Mask(offset);
mask_tmp = ShiftRows(mask_tmp);
mask = mask_tmp;
end



##### SOURCE END #####
--></body></html>